-- Flyway migration V19, Part 14

INSERT INTO `wiki_documentation` (`file_path`, `content`) VALUES
('src/main/java/de/technikteam/servlet/PackKitServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet generates a printable \"packing list\" page for a specific inventory kit. It is designed to be accessed via a QR code, providing a simple, mobile-friendly checklist of items that belong in a particular case or kit.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as a controller for a read-only, utility view. It interacts directly with the `InventoryKitDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `InventoryKitDAO`.\n    *   `InventoryKitDAO`: Used to fetch the kit''s details and its list of required items.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the `/pack-kit` URL.\n        *   **Logic:**\n            1.  **Parameter Validation:** It requires a `kitId` parameter.\n            2.  **Data Fetching:**\n                *   It retrieves the main `InventoryKit` object (for its name and description) using `kitDAO.getKitById()`.\n                *   It retrieves the list of `InventoryKitItem`s for that kit using `kitDAO.getItemsForKit()`.\n            3.  **Forwarding:** It sets the `kit` and `kitItems` as request attributes and forwards to `views/public/pack_kit.jsp`. This JSP is styled for a clean, printable view and has the main navigation hidden.'),
('src/main/java/de/technikteam/servlet/PasswordServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet manages the process for a logged-in user to change their own password. It handles rendering the password change form for GET requests and processes the form submission for POST requests, including validation of the current password, new password confirmation, and adherence to the password policy.\n\n2.  **Architectural Role**\n\n    This class belongs to the **Web/Controller Tier**. It is a self-contained controller for a specific user action. It interacts with the `UserDAO` for credential validation and updates, and uses the `PasswordPolicyValidator` for business logic.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `UserDAO`.\n    *   `UserDAO`: Used to validate the user''s current password and to save the new hashed password.\n    *   `PasswordPolicyValidator`: A utility class that enforces complexity requirements for new passwords.\n    *   `CSRFUtil`: Used to validate the CSRF token on the POST request.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(...)`**: Simply forwards the request to the `passwort.jsp` view, which contains the password change form.\n\n    *   **`doPost(HttpServletRequest request, HttpServletResponse response)`**:\n        *   **Purpose:** Processes the password change form submission.\n        *   **Logic:**\n            1.  **Authentication & Security:** Ensures a user is logged in and validates the CSRF token.\n            2.  **Parameter Retrieval:** Gets the `currentPassword`, `newPassword`, and `confirmPassword` from the request.\n            3.  **Current Password Validation:** It calls `userDAO.validateUser()` with the current user''s name and the provided `currentPassword`. If this fails, it sets an error message and redirects back.\n            4.  **Confirmation Check:** It verifies that `newPassword` and `confirmPassword` are identical.\n            5.  **Policy Validation:** It calls `PasswordPolicyValidator.validate()` on the `newPassword`. If the new password does not meet the complexity requirements, it sets an error message with the specific reason and redirects.\n            6.  **Database Update:** If all checks pass, it calls `userDAO.changePassword()` to hash and save the new password.\n            7.  **Feedback & Redirect:** It sets a success or error message in the session and redirects the user back to the `/passwort` page.'),
('src/main/java/de/technikteam/servlet/ProfileServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves as the controller for the \"Mein Profil\" (My Profile) page. For GET requests, it aggregates and displays a comprehensive overview of the logged-in user''s data, including their profile information, event history, qualifications, achievements, and registered passkeys. For POST requests, it handles various profile-related actions like submitting a profile change request or deleting a passkey.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as a central hub for user-specific data display and modification. It interacts with a wide range of DAOs to collect the necessary information.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects `EventDAO`, `UserQualificationsDAO`, `UserDAO`, `AchievementDAO`, `PasskeyDAO`, and `ProfileChangeRequestDAO`.\n    *   **DAOs**: Each DAO is used to fetch a specific slice of the user''s data.\n    *   **Gson**: Used to serialize the JSON payload for the profile change request.\n    *   `CSRFUtil`: For validating all POST actions.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(...)`**:\n        *   **Purpose:** Gathers all data for the profile page.\n        *   **Logic:** It makes calls to multiple DAOs (`eventDAO.getEventHistoryForUser`, `qualificationsDAO.getQualificationsForUser`, etc.) to fetch all the different pieces of information. It also checks if the user has an outstanding change request using `requestDAO.hasPendingRequest()`. All retrieved data is set as request attributes before forwarding to `profile.jsp`.\n\n    *   **`doPost(...)`**:\n        *   **Purpose:** Handles various actions submitted from the profile page.\n        *   **Logic:** After validating the CSRF token, it uses a `switch` statement on the `action` parameter to route to the appropriate handler method.\n\n    *   **`handleDeletePasskey(...)`**: Deletes a user''s passkey credential after they confirm the action.\n\n    *   **`handleUpdateChatColor(...)`**: Updates the user''s preferred chat color in the database and in their current session object.\n\n    *   **`handleProfileChangeRequest(...)`**:\n        *   **Purpose:** Handles the submission of a profile data change request from the user. This is an AJAX endpoint.\n        *   **Logic:**\n            1.  It compares the submitted form values (`email`, `classYear`, `className`) with the values in the current user''s session object.\n            2.  It builds a `Map` containing only the fields that have actually changed.\n            3.  If there are no changes, it returns an error response.\n            4.  If there are changes, it serializes the `Map` to a JSON string.\n            5.  It creates a new `ProfileChangeRequest` object, sets the JSON string as the `requestedChanges`, and saves it to the database via the `requestDAO`.\n            6.  It returns a JSON `ApiResponse` indicating success or failure.'),
('src/main/java/de/technikteam/servlet/RootServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet is mapped to the root URL (`/`) of the application. Its sole purpose is to act as a router, directing users to the appropriate starting page based on their authentication status.\n\n2.  **Architectural Role**\n\n    This is a simple entry point in the **Web/Controller Tier**. It ensures users landing on the base URL are sent to either the login page or their dashboard, preventing them from seeing a blank or error page.\n\n3.  **Key Dependencies & Libraries**\n\n    *   **Jakarta Servlet API**: The base `HttpServlet` class.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles all GET requests to the application''s root context.\n        *   **Logic:**\n            1.  It checks the `HttpSession` for a `User` object.\n            2.  If a `User` object exists (the user is logged in), it sends a redirect to the `/home` servlet.\n            3.  If no `User` object exists (the user is not logged in), it sends a redirect to the `/login` servlet.'),
('src/main/java/de/technikteam/servlet/StorageItemActionServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves the dedicated \"QR Action\" page, which is designed to be accessed by scanning a QR code associated with an inventory item. It provides a simplified, mobile-friendly interface for performing a quick check-in or check-out transaction for a specific item.\n\n2.  **Architectural Role**\n\n    This class belongs to the **Web/Controller Tier**. It acts as the controller for the QR code landing page. It interacts with the `StorageDAO` and `EventDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `StorageDAO` and `EventDAO`.\n    *   `StorageDAO`: To fetch the details of the specific item.\n    *   `EventDAO`: To fetch a list of active events to populate the \"assign to event\" dropdown.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests, typically from a QR code scan.\n        *   **Logic:**\n            1.  **Parameter Validation:** It requires an `id` parameter identifying the storage item.\n            2.  **Data Fetching:**\n                *   It retrieves the full `StorageItem` object using `storageDAO.getItemById()`.\n                *   It fetches all currently active events using `eventDAO.getActiveEvents()`.\n            3.  **Error Handling:** If the item ID is invalid or the item is not found, it sends an appropriate HTTP error.\n            4.  **Forwarding:** It sets the `item` and `activeEvents` as request attributes and forwards to `views/public/qr_action.jsp`. This JSP has a simplified layout without the main navigation, optimized for quick actions on a mobile device.'),
('src/main/java/de/technikteam/servlet/StorageItemDetailsServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet is responsible for displaying the detailed information page for a single inventory item. It aggregates the item''s core data, its transaction history, and its maintenance history into a single view.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as the controller for the item details page. It coordinates calls to `StorageDAO`, `StorageLogDAO`, and `MaintenanceLogDAO` to build a complete picture of the item.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the three DAOs responsible for storage data.\n    *   `StorageDAO`: To fetch the main `StorageItem` object.\n    *   `StorageLogDAO`: To fetch the item''s checkout/checkin history.\n    *   `MaintenanceLogDAO`: To fetch the item''s repair/maintenance history.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the item details page.\n        *   **Logic:**\n            1.  **Parameter Validation:** It validates that a numerical `id` parameter is present.\n            2.  **Data Fetching:** It makes three separate DAO calls:\n                *   `storageDAO.getItemById()` to get the core item details.\n                *   `storageLogDAO.getHistoryForItem()` to get the transaction log.\n                *   `maintenanceLogDAO.getHistoryForItem()` to get the maintenance log.\n            3.  **Error Handling:** If the item is not found, it sends an HTTP 404 error.\n            4.  **Forwarding:** It sets the `item`, `history`, and `maintenanceHistory` as request attributes and forwards the request to `views/public/storage_item_details.jsp`.'),
('src/main/java/de/technikteam/servlet/StorageServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves the main public-facing \"Lager\" (Inventory) page. Its job is to fetch all inventory items, grouped by their physical location, and prepare the data for display in the `lager.jsp` view.\n\n2.  **Architectural Role**\n\n    This class belongs to the **Web/Controller Tier**. It acts as the controller for the main inventory overview page. It interacts with the `StorageDAO` and `EventDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `StorageDAO` and `EventDAO`.\n    *   `StorageDAO`: Used to fetch all inventory items, grouped by location.\n    *   `EventDAO`: Used to fetch a list of active events to populate the dropdown in the transaction modal.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the `/lager` page.\n        *   **Logic:**\n            1.  It calls `storageDAO.getAllItemsGroupedByLocation()` to retrieve all storage items, pre-organized into a `Map` where keys are location names and values are lists of items in that location.\n            2.  It calls `eventDAO.getActiveEvents()` to get a list of events that can be associated with a transaction.\n            3.  It sets both the `storageData` map and the `activeEvents` list as request attributes.\n            4.  It forwards the request to `views/public/lager.jsp`.'),
('src/main/java/de/technikteam/servlet/StorageTransactionServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet processes inventory transaction requests (check-ins and check-outs) submitted from the public inventory page (`lager.jsp`) or the QR action page (`qr_action.jsp`). It acts as the endpoint for these state-changing operations, delegating the complex transactional logic to the `StorageService`.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It receives form data, performs basic validation, and then calls the **Service Tier** (`StorageService`) to execute the core business logic. It should not contain any transaction management or complex logic itself.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `StorageService`.\n    *   `StorageService`: The service that handles the transactional logic of checking items in or out.\n    *   `CSRFUtil`: Used for security validation on the POST request.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doPost(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles POST requests to perform a storage transaction.\n        *   **Logic:**\n            1.  **Security & Validation:** It validates the CSRF token and retrieves the logged-in `User` from the session.\n            2.  **Parameter Parsing:** It parses all necessary parameters from the request: `itemId`, `quantity`, `type` (\"checkout\" or \"checkin\"), `notes`, and the optional `eventId`.\n            3.  **Service Call:** It calls `storageService.processTransaction()` with the parsed parameters. This single method call handles the entire transactional operation.\n            4.  **Feedback & Redirect:** Based on the boolean result from the service call, it sets either a `successMessage` or an `errorMessage` in the user''s session.\n            5.  It then redirects the user back to their original page (either `/lager` or the QR action page, determined by the `redirectUrl` parameter).'),
('src/main/java/de/technikteam/servlet/TaskActionServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves as a dedicated controller for all actions related to event tasks. It handles a variety of POST requests for creating, updating, deleting, and changing the status of tasks, as well as user-specific actions like claiming or un-claiming a task.\n\n2.  **Architectural Role**\n\n    This class belongs to the **Web/Controller Tier**. It acts as a command handler for task-related operations, primarily receiving requests from the `eventDetails.jsp` page. It coordinates between user actions and the `EventTaskDAO`, and performs necessary authorization checks.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `EventTaskDAO`, `EventDAO`, and `AdminLogService`.\n    *   `EventTaskDAO`: The primary DAO for all task-related database operations.\n    *   `EventDAO`: Used to fetch event details for authorization checks (e.g., to verify if the current user is the event leader).\n    *   `AdminLogService`: To log administrative actions like creating or deleting tasks.\n    *   `CSRFUtil`: For security validation on all POST requests.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doPost(HttpServletRequest request, HttpServletResponse response)`**:\n        *   **Purpose:** The main entry point that routes requests based on the `action` parameter.\n        *   **Logic:** After authenticating the user and validating the CSRF token, it uses a `switch` statement to delegate to the appropriate handler method (`handleSaveTask`, `handleDeleteTask`, etc.).\n\n    *   **`handleSaveTask(...)`**:\n        *   **Purpose:** Handles both creation and updating of a task.\n        *   **Logic:**\n            1.  Performs an authorization check: only an admin or the event leader can save a task.\n            2.  It constructs an `EventTask` object from the request parameters.\n            3.  It determines if it''s a create or update based on the presence of a `taskId`.\n            4.  It collects arrays of associated data (assigned user IDs, required item IDs, etc.) from the request.\n            5.  It calls the transactional `taskDAO.saveTask()` method, which handles saving the task and all its relationships.\n            6.  Logs the action and sets a session message before redirecting back to the event details page.\n\n    *   **`handleDeleteTask(...)`**:\n        *   **Purpose:** Deletes a task.\n        *   **Logic:** Performs an authorization check (admin or event leader), then calls `taskDAO.deleteTask()`, logs the action, sets a session message, and redirects.\n\n    *   **`handleUserTaskAction(...)`**:\n        *   **Purpose:** Handles actions that a regular participant can perform on a task.\n        *   **Logic:**\n            *   For `updateStatus` (e.g., marking as \"ERLEDIGT\"), it checks if the user is an admin, the leader, or an assignee of the task.\n            *   For `claim` and `unclaim`, it checks if the user is a participant in the event.\n            *   It then calls the appropriate `EventTaskDAO` method to perform the action.'),
('src/main/java/de/technikteam/util/CSRFUtil.java', '1.  **File Overview & Purpose**\n\n    This is a critical security utility class that provides methods to protect the application against Cross-Site Request Forgery (CSRF) attacks. It implements the synchronizer token pattern by generating a secure, random token, storing it in the user''s session, and providing a method to validate that incoming state-changing requests include this same token.\n\n2.  **Architectural Role**\n\n    This is a cross-cutting **Security/Utility** component. It is used throughout the **Web/Controller Tier**. The `storeToken` method is called by the `LoginServlet`, and the `isTokenValid` method is called at the beginning of the `doPost` method of nearly every servlet that handles form submissions.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `java.security.SecureRandom`: Used to generate cryptographically strong random bytes for the token.\n    *   `java.util.Base64`: Used to encode the random bytes into a URL-safe string.\n\n4.  **In-Depth Breakdown**\n\n    *   **`storeToken(HttpSession session)`**:\n        *   **Purpose:** Generates a new CSRF token and saves it in the user''s session.\n        *   **Logic:** It calls the private `generateToken()` method and sets the result as a session attribute with the key `\"csrfToken\"`. This should be called upon successful login to establish the initial token.\n\n    *   **`generateToken()`**:\n        *   **Purpose:** A private helper to create a secure, random token.\n        *   **Logic:** It uses `SecureRandom` to generate 32 random bytes and then Base64-encodes them into a URL-safe, padding-free string.\n\n    *   **`isTokenValid(HttpServletRequest request)`**:\n        *   **Purpose:** The main validation method. It compares the token submitted in a request parameter with the token stored in the session.\n        *   **Logic:** It retrieves the token from the session and the token from the request parameter named `\"csrfToken\"`. It performs null/empty checks and then uses `Objects.equals()` for a timing-attack-safe comparison. It returns `true` only if both tokens exist and are identical.\n\n    *   **`getCsrfInputField(HttpSession session)`**: A utility method intended for use in JSPs (though the project uses direct EL `$${sessionScope.csrfToken}` instead). It generates the complete `<input type=\"hidden\" ...>` HTML tag needed in forms.');
COMMIT;