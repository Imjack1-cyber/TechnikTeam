-- Flyway migration V18, Part 13

INSERT INTO `wiki_documentation` (`file_path`, `content`) VALUES
('src/main/java/de/servlet/IcalServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet generates an iCalendar (`.ics`) feed of all active and upcoming events and meetings. This allows users to subscribe to the application''s schedule using external calendar applications like Google Calendar, Outlook, or Apple Calendar.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as a specialized API endpoint that produces data in the iCalendar format instead of HTML or JSON. It interacts with the `EventDAO` and `MeetingDAO` to source its data.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `EventDAO` and `MeetingDAO`.\n    *   **iCal4j (`net.fortuna.ical4j.*`)**: The core third-party library used to programmatically build the iCalendar data structure.\n    *   `EventDAO`, `MeetingDAO`: Used to fetch all public calendar entries.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests to `/calendar.ics`.\n        *   **Logic:**\n            1.  **Initialize Calendar:** Creates a new iCal4j `Calendar` object and sets the standard `PRODID` and `VERSION` properties.\n            2.  **Fetch Events & Meetings:** Retrieves all active and upcoming events and meetings from the DAOs.\n            3.  **Create VEvents:** It iterates through both lists. For each `Event` and `Meeting`, it creates a `VEvent` component.\n            4.  **Populate VEvent Properties:** It populates each `VEvent` with standard iCalendar properties:\n                *   `UID`: A unique identifier for the event.\n                *   `DTSTART` / `DTEND`: The start and end times. It correctly converts the Java `LocalDateTime` to a `java.util.Date` required by iCal4j.\n                *   `SUMMARY`: The event/meeting title.\n                *   `DESCRIPTION`: The event/meeting description.\n                *   `LOCATION`: The event/meeting location.\n                *   `URL`: A direct link back to the event/meeting details page within the application.\n            5.  **Set Response Headers:** It sets the `Content-Type` to `text/calendar` and the `Content-Disposition` to `inline`, suggesting to the browser that it should be opened by a calendar application.\n            6.  **Output:** Uses a `CalendarOutputter` from iCal4j to write the fully constructed calendar object to the servlet''s response stream.'),
('src/main/java/de/servlet/ImageServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet is responsible for securely serving images stored in the `images` subdirectory of the main upload folder. It prevents direct access to the filesystem, performs authorization checks, and includes protection against path traversal attacks.\n\n2.  **Architectural Role**\n\n    This class belongs to the **Web/Controller Tier**. It acts as a secure proxy for image files, ensuring that only authenticated users can access them and that they cannot request files outside the designated image directory.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `ConfigurationService`.\n    *   `ConfigurationService`: Provides the base path for file uploads.\n    *   `User` (Model): Retrieved from the session for authentication and logging purposes.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for images.\n        *   **Logic:**\n            1.  **Authentication:** Checks for a valid user session.\n            2.  **Parameter Validation:** Ensures the `file` parameter is present.\n            3.  **Path Traversal Protection:** This is the most critical security feature.\n                *   It constructs the canonical (absolute) path for both the base image directory and the requested file.\n                *   It then checks if the canonical path of the requested file *starts with* the canonical path of the base directory. If not, it means the user is trying to access a file outside the intended directory (e.g., using `../`), a path traversal attack.\n                *   In case of a detected attack, it logs a `FATAL` error and returns a 403 Forbidden error.\n            4.  **File Existence Check:** Verifies that the requested file exists and is not a directory.\n            5.  **Set Headers:** It determines the MIME type of the image (e.g., `image/jpeg`, `image/png`) and sets the `Content-Type`, `Content-Length`, and `Content-Disposition: inline` headers. `inline` suggests that the browser should display the image directly rather than prompting for a download.\n            6.  **Streaming:** It streams the file''s bytes from a `FileInputStream` to the response''s `OutputStream`.'),
('src/main/java/de/servlet/LoginServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet handles the user authentication process. It serves the login page (`login.jsp`) for GET requests and processes login form submissions for POST requests. It includes logic for validating credentials, managing failed login attempts, and implementing an escalating lockout mechanism to thwart brute-force attacks.\n\n2.  **Architectural Role**\n\n    This class is a central part of the **Web/Controller Tier**. It is the main entry point for user authentication. It interacts directly with the `UserDAO` to validate credentials and manages the `HttpSession` to establish a logged-in state.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `UserDAO`.\n    *   `UserDAO`: Used to validate the username and password against the database.\n    *   `NavigationRegistry`: Used to build the user-specific navigation menu after a successful login.\n    *   `CSRFUtil`: Used to generate and store a new CSRF token in the session upon successful login.\n\n4.  **In-Depth Breakdown**\n\n    *   **`LoginAttemptManager` (Inner Class):**\n        *   **Purpose:** A static inner class that encapsulates all logic related to tracking and managing failed login attempts.\n        *   **`MAX_ATTEMPTS`**: The number of failed attempts before a lockout is triggered.\n        *   **`LOCKOUT_DURATIONS_MS`**: An array defining the escalating lockout durations in milliseconds for subsequent lockouts.\n        *   **`isLockedOut(String username)`**: Checks if a user is currently within a lockout period.\n        *   **`recordFailedLogin(String username)`**: Increments the failed attempt counter for a user. If the count reaches the maximum, it initiates a lockout.\n        *   **`clearLoginAttempts(String username)`**: Resets all attempt counters and lockout information for a user, typically after a successful login.\n\n    *   **`doPost(HttpServletRequest request, HttpServletResponse response)`**:\n        *   **Purpose:** Processes the login form submission.\n        *   **Logic:**\n            1.  Retrieves `username` and `password` from the request.\n            2.  **Lockout Check:** First, it checks if the user is currently locked out using `LoginAttemptManager.isLockedOut()`. If so, it sets session attributes to inform the JSP and redirects back.\n            3.  **Credential Validation:** It calls `userDAO.validateUser()`.\n            4.  **Success Path:** If `validateUser` returns a `User` object, it means the login was successful.\n                *   It clears any previous failed login attempts for that user.\n                *   It invalidates the old session and creates a new one to prevent session fixation attacks.\n                *   It stores the `User` object in the new session.\n                *   It generates a new CSRF token.\n                *   It builds the user''s navigation menu and stores it in the session.\n                *   It redirects the user to the `/home` page.\n            5.  **Failure Path:** If `validateUser` returns `null`, the login failed.\n                *   It records the failed attempt using `LoginAttemptManager.recordFailedLogin()`.\n                *   It sets error messages and the failed username in the session for the JSP to display.\n                *   It redirects the user back to the `/login` page.\n\n    *   **`doGet(...)`**: Simply forwards the request to the `login.jsp` view.'),
('src/main/java/de/servlet/LogoutServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet handles the user logout process. It invalidates the current user''s session, effectively logging them out, and then redirects them to the login page with a success message.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It is the dedicated endpoint for terminating a user''s authenticated session.\n\n3.  **Key Dependencies & Libraries**\n\n    *   **Jakarta Servlet API (`jakarta.servlet.http.HttpSession`)**: Used to access and invalidate the user''s session.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests to the `/logout` URL.\n        *   **Logic:**\n            1.  It retrieves the current `HttpSession` without creating a new one (`request.getSession(false)`).\n            2.  If a session exists, it logs which user is logging out and then calls `session.invalidate()`. This is the core action that removes all session attributes and effectively logs the user out.\n            3.  It then creates a *new* session (`request.getSession(true)`) to store a \"successMessage\" that can be displayed on the login page.\n            4.  Finally, it redirects the user to the `/login` page.'),
('src/main/java/de/servlet/MarkdownEditorServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves the real-time Markdown editor page. It is responsible for fetching the content of a specific Markdown file, performing authorization checks to determine if the user can view or edit the file, and then forwarding the data to the `admin_editor.jsp` view.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as the controller for the collaborative editor view. It interacts with the `FileDAO` to retrieve file metadata and content.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `FileDAO` and `ConfigurationService`.\n    *   `FileDAO`: Used to get the file''s metadata and read its physical content.\n    *   `ConfigurationService`: Provides the base path to the upload directory.\n    *   `User` (Model): The user object from the session, used for authorization.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the `/editor` page.\n        *   **Logic:**\n            1.  **Authentication & Parameter Validation:** Ensures a user is logged in and that a valid `fileId` is provided.\n            2.  **Fetch File Metadata:** Retrieves the `File` object from the database using `fileDAO.getFileById()`.\n            3.  **Authorization:** It checks the user''s permissions (`FILE_UPDATE` or `ACCESS_ADMIN_PANEL` for editing, `FILE_READ` for viewing). Based on the check, it sets an `editorMode` attribute (\"edit\" or \"view\") for the JSP. If the user has neither permission, it returns a 403 Forbidden error.\n            4.  **Fetch File Content:** It reads the physical file''s content from the disk using the path stored in the `dbFile` object. It includes error handling for cases where the file is in the database but missing from the disk.\n            5.  **Forwarding:** It sets the `file` object and its `fileContent` as request attributes and forwards to `admin_editor.jsp`.'),
('src/main/java/de/servlet/MeetingActionServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet handles user actions related to meetings, specifically signing up for and signing off from a meeting. It processes POST requests from the public meetings list page (`lehrgaenge.jsp`).\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as the controller for user-initiated meeting attendance changes. It interacts directly with the `MeetingAttendanceDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `MeetingAttendanceDAO`.\n    *   `MeetingAttendanceDAO`: The DAO used to update the user''s attendance status.\n    *   `CSRFUtil`: Used for security validation.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doPost(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles POST requests for meeting actions.\n        *   **Logic:**\n            1.  **Security & Validation:** It validates the CSRF token and ensures a user is logged in and that `action` and `meetingId` parameters are present.\n            2.  **Action Handling:**\n                *   If `action` is `\"signup\"`, it calls `attendanceDAO.setAttendance()` with `attended=true`.\n                *   If `action` is `\"signoff\"`, it calls `attendanceDAO.setAttendance()` with `attended=false`.\n            3.  **Feedback & Redirect:** It sets a success message in the session and redirects the user back to the `/lehrgaenge` page.'),
('src/main/java/de/servlet/MeetingDetailsServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet is responsible for preparing and displaying the detailed view of a single meeting. It fetches the meeting''s data and its associated file attachments, performs an authorization check, and forwards the information to the `meetingDetails.jsp` view.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as the controller for the meeting details page. It interacts with the `MeetingDAO` and `AttachmentDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `MeetingDAO` and `AttachmentDAO`.\n    *   `MeetingDAO`: Used to fetch the core meeting data and check for user association.\n    *   `AttachmentDAO`: Used to fetch attachments specific to this meeting.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the meeting details page.\n        *   **Logic:**\n            1.  **Authentication & Validation:** Ensures a user is logged in and a valid `id` parameter is present.\n            2.  **Fetch Meeting Data:** Retrieves the `Meeting` object from the DAO.\n            3.  **Authorization:** A user is authorized to view the details if they are an admin, the meeting leader, or a participant. If not, it sends a 403 Forbidden error.\n            4.  **Fetch Attachments:** It calls `attachmentDAO.getAttachmentsForParent()`, passing \"MEETING\" as the type and filtering by the user''s role to determine which attachments should be visible.\n            5.  **Forwarding:** Sets the `meeting` and `attachments` as request attributes and forwards to `meetingDetails.jsp`.'),
('src/main/java/de/servlet/MeetingServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves the main \"Lehrg√§nge\" (Courses/Meetings) page. It fetches the list of all upcoming meetings and determines the current user''s sign-up status for each one.\n\n2.  **Architectural Role**\n\n    This class belongs to the **Web/Controller Tier**. It acts as the controller for the public listing of schedulable meetings. It interacts directly with the `MeetingDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `MeetingDAO`.\n    *   `MeetingDAO`: Used to fetch the upcoming meetings and the user''s status for each.\n    *   `User` (Model): The user object from the session, used to get user-specific data.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the `/lehrgaenge` page.\n        *   **Logic:**\n            1.  Retrieves the logged-in `User`.\n            2.  Calls `meetingDAO.getUpcomingMeetingsForUser(user)`. This single DAO call efficiently retrieves all upcoming meetings and, through a `LEFT JOIN`, also fetches the user''s attendance status (`ANGEMELDET`, `ABGEMELDET`, or `OFFEN`) for each.\n            3.  Sets the resulting list of `Meeting` objects as a request attribute.\n            4.  Forwards the request to `views/public/lehrgaenge.jsp`.'),
('src/main/java/de/servlet/MyFeedbackServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet serves the \"Mein Feedback\" page, which allows users to view the status of their own previously submitted feedback. It fetches all submissions made by the currently logged-in user.\n\n2.  **Architectural Role**\n\n    This class is part of the **Web/Controller Tier**. It acts as the controller for a user''s personal feedback history view. It interacts directly with the `FeedbackSubmissionDAO`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `@Inject`: Injects the `FeedbackSubmissionDAO`.\n    *   `FeedbackSubmissionDAO`: The DAO used to retrieve submissions by user ID.\n    *   `User` (Model): The user object from the session.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests for the `/my-feedback` page.\n        *   **Logic:**\n            1.  Ensures a user is logged in.\n            2.  Calls `submissionDAO.getSubmissionsByUserId()` using the logged-in user''s ID.\n            3.  Sets the resulting list of `FeedbackSubmission` objects as a request attribute.\n            4.  Forwards the request to `views/public/my_feedback.jsp`.'),
('src/main/java/de/servlet/NotificationServlet.java', '1.  **File Overview & Purpose**\n\n    This servlet is the client-facing endpoint for establishing a Server-Sent Events (SSE) connection. Authenticated clients connect to this servlet to receive real-time push notifications from the server. This servlet''s only job is to register the client''s connection with the `NotificationService`.\n\n2.  **Architectural Role**\n\n    This is a specialized controller in the **Web/Controller Tier**. It handles the initial setup of the long-lived HTTP connection required for SSE. All subsequent communication is managed by the `NotificationService`.\n\n3.  **Key Dependencies & Libraries**\n\n    *   `NotificationService`: The singleton service where the client connection is registered.\n    *   **Jakarta Servlet API (`AsyncContext`)**: The underlying mechanism used to keep the connection open asynchronously.\n\n4.  **In-Depth Breakdown**\n\n    *   **`doGet(HttpServletRequest request, HttpServletResponse response)`**\n        *   **Purpose:** Handles GET requests to `/notifications`.\n        *   **Logic:**\n            1.  **Authentication:** It ensures a user is logged in. Unauthorized requests are rejected.\n            2.  **Set SSE Headers:** It sets the necessary HTTP headers for an SSE connection: `Content-Type: text/event-stream`, `Cache-Control: no-cache`, and `Connection: keep-alive`.\n            3.  **Register with Service:** It calls `NotificationService.getInstance().register(request)`. This call is the core of the servlet; it starts an `AsyncContext`, effectively handing off the connection to the `NotificationService` to be managed for the duration of the SSE session.');
COMMIT;